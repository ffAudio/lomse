<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Lomse library. API documentation: Rendering documents overview</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="lomse.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo_100x195.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Lomse library. API documentation
   &#160;<span id="projectnumber">0.27.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('page-render-overview.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Rendering documents overview </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#mvc-rendering">How to render a document</a></li>
<li class="level1"><a href="#mvc-overview">The Lomse Model-View-Controller</a></li>
<li class="level1"><a href="#rendering-buffer">The rendering buffer for the View</a></li>
<li class="level1"><a href="#init-lomse">Initializing the Lomse library</a></li>
<li class="level1"><a href="#rendering-display">Displaying the document</a></li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="mvc-rendering"></a>
How to render a document</h1>
<p>The first and most important thing to learn about Lomse is that is platform independent code, with no knowledge about things such as how to display a document on a window on the screen or how to handle mouse events. Lomse provides the necessary services and interfaces for displaying documents and interacting with them but it is your application responsibility to code the presentation layer, that is the methods and functions for asking for services to the operating system (e.g. creating windows, receiving mouse events, etc.) and for requesting Lomse the appropiate services, such as rendering the document in the windows buffer or handling the passed events.</p>
<p>Lomse works by rendering the documents on a bitmap buffer, that is, on an array of consecutive memory bytes. This buffer can be any type of memory, such as a real bitmap, a window's buffer, etc. The simplest and usual way of rendering documents on a window is:</p><ol type="1">
<li>Create a new empty bitmap when necessary (i.e when the window is created or resized),</li>
<li>Ask Lomse to render the desired portion of the document on this bitmap, and</li>
<li>Copy the bitmap onto the window.</li>
</ol>
<p>These operations are usually triggered by your application when handling some operating system events, such as <b>window paint</b> events. Before entering into details it is necessary to understand some important concepts. If you are new to Lomse, <b>please</b> read in sequence this document.</p>
<h1><a class="anchor" id="mvc-overview"></a>
The Lomse Model-View-Controller</h1>
<p>The Model-View-Controller (MVC) is an architecture for providing isolation between the various functions of the GUI: maintaining the document (the Model), displaying all or a portion of the document (the View), and handling events that affect the model or the view(s) (the Controller).</p>
<p>Lomse MVC model has four components: the <code>Model</code> (the document), the <code>View</code> (its visual representation), the <code><a class="el" href="classInteractor.html">Interactor</a></code> (a kind of Controller) and the <code><a class="el" href="classPresenter.html">Presenter</a></code> (the 'glue' to join all the pieces):</p>
<ul>
<li>The Document object (the Model) stores the document content (music scores, paragraphs, images, etc.) and notifies other objects when changes occur to the document.</li>
<li>The View object takes care of rendering the document so that it can be displayed by your application. The View is responsible for providing the rendered document, usually by providing a bitmap, and it is your application responsibility to present this bitmap to the user (i.e. render it on a window, save it in a file, print it, or produce any other desired output). The rendering type depends on the specific View class used. For instance, class <a class="el" href="classGraphicView.html">GraphicView</a> renders the document on a bitmap. Other classes would be possible (i.e. a view class to render the document as an SVG stream, a view for rendering as Braille code, a view for rendering as source code, etc.) but currently Lomse only has implemented several variations of <a class="el" href="classGraphicView.html">GraphicView</a> (<a class="el" href="classVerticalBookView.html">VerticalBookView</a>, <a class="el" href="classHorizontalBookView.html">HorizontalBookView</a>, and <a class="el" href="classSingleSystemView.html">SingleSystemView</a>).</li>
<li>A Document can have many View objects. For instance, your application can display two windows, one for presenting a music score as a music sheet, and another window for displaying the same music score but as MusicXML source code. This behaviour can be achived by associating two simultaneous views to the document.</li>
<li>The <a class="el" href="classInteractor.html">Interactor</a> object plays the role of the Controller in the MVC model. Each View has an associated Interactor (in fact the View is owned by the Interactor). The Interactor is the interface between your application, the associated View and the Document. It is responsible for translating your application requests into commands that manipulate the associated View and/or the Document, coordinating all the necessary actions.</li>
<li>Finally, the <a class="el" href="classPresenter.html">Presenter</a> object (short for <em>document presenter</em>) is the glue that links all objects in the MVC model. It maintains the life cycle and relationships between Views, Interactors, Commands, Selections, and the Document.</li>
</ul>
<p>The Presenter and most associated objects are created when your application invokes any of the methods in <a class="el" href="classLomseDoorway.html">LomseDoorway</a> for opening/creating documents:</p>
<div class="fragment"><div class="line"><a class="code" href="classLomseDoorway.html">LomseDoorway</a>    m_lomse;</div><div class="line"><a class="code" href="classPresenter.html">Presenter</a>*      m_pPresenter = m_lomse.<a class="code" href="classLomseDoorway.html#a1b00546f591c2041df5ed86ea0681948">new_document</a>(...);</div></div><!-- fragment --><p>Your application will take ownership of the Presenter and will have to delete it when no longer needed. Deleting the Presenter will automaticall cause deletion of all MVC involved objets: the Document, all existing Views and their Interactors, selection sets, undo/redo stacks, etc.</p>
<p>By default, when the presented is created a View and its <a class="el" href="classInteractor.html">Interactor</a> are created. Method <a class="el" href="classPresenter.html#a3542802890a4615d251a5a786cee62b5">Presenter::get_interactor()</a> provides a <a href="https://en.wikipedia.org/wiki/Smart_pointer">smart pointer</a> to the desired Interactor:</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (SpInteractor spInteractor = m_pPresenter-&gt;<a class="code" href="classPresenter.html#a3542802890a4615d251a5a786cee62b5">get_interactor</a>(0).lock())</div><div class="line">{</div><div class="line">    <span class="comment">//use the Interactor</span></div><div class="line">    spInteractor-&gt;some_method();</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><p>Normally, the Interactor is the only object you would need to use for interacting with the associated View and with the Document.</p>
<h1><a class="anchor" id="rendering-buffer"></a>
The rendering buffer for the View</h1>
<p>The View renders the document on a memory buffer that your application must provide. Once Lomse has rendered the document on this bitmap buffer, it is your application responsibility to do whatever is needed with the bitmap: rendering it on a window, exporting it as a file, printing it, etc.</p>
<p>Once the View is created (remember that it is created automatically when your application invokes any of the methods in <a class="el" href="classLomseDoorway.html">LomseDoorway</a> for opening/creating documents), the next step is to associate a RenderingBuffer object to the View. This object is just a wrapper for the real memory buffer:</p>
<div class="fragment"><div class="line"><span class="comment">//some MyWindow class member variables:</span></div><div class="line"><a class="code" href="classLomseDoorway.html">LomseDoorway</a>&amp;       m_lomse;            <span class="comment">//the Lomse library doorway</span></div><div class="line"><a class="code" href="classPresenter.html">Presenter</a>*          m_pPresenter;       <span class="comment">//the Presenter for this window</span></div><div class="line">RenderingBuffer     m_rbuf;             <span class="comment">//the RenderingBuffer for this window</span></div><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*      m_pBuffer;          <span class="comment">//ptr to the real memory for the bitmap</span></div><div class="line"></div><div class="line">MyWindow::MyWindow(<a class="code" href="classLomseDoorway.html">LomseDoorway</a>&amp; <a class="code" href="namespacelomse.html">lomse</a>)</div><div class="line">    : m_lomse(lomse)</div><div class="line">    , m_pPresenter(NULL)</div><div class="line">    , m_pBuffer(NULL)</div><div class="line">{</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> MyWindow::on_new_document()</div><div class="line"></div><div class="line">{</div><div class="line">    <span class="keyword">delete</span> m_pPresenter;</div><div class="line">    m_pPresenter = m_lomse.<a class="code" href="classLomseDoorway.html#a1b00546f591c2041df5ed86ea0681948">new_document</a>(....);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (SpInteractor spInteractor = m_pPresenter-&gt;<a class="code" href="classPresenter.html#a3542802890a4615d251a5a786cee62b5">get_interactor</a>(0).lock())</div><div class="line">    {</div><div class="line">        <span class="comment">//connect the View with the rendering buffer</span></div><div class="line">        spInteractor-&gt;set_rendering_buffer(&amp;m_rbuf);</div><div class="line">    }</div><div class="line"></div><div class="line">}</div></div><!-- fragment --><p>Notice that the real memory for the buffer is not yet allocated. The memory must be allocated when necessary, normally when the window is created and each time it is resized. Therefore, the event handler for <b>window resize</b> events is, usually, the best place for allocating memory for the buffer:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> MyWindow::handle_resize_event(<span class="keywordtype">unsigned</span> new_width, <span class="keywordtype">unsigned</span> new_height)</div><div class="line">{</div><div class="line">    <span class="comment">//create a new bitmap for the rendering buffer. The old buffer is</span></div><div class="line">    <span class="comment">//automatically deleted by Lomse</span></div><div class="line">    m_pBuffer = ...   <span class="comment">//many possibilities for allocating memory or reusing memory</span></div><div class="line">    <span class="keywordtype">int</span> stride = width * bytes_per_pixel;   <span class="comment">//bitmap: number of bytes per row</span></div><div class="line">    m_rbuf_window.attach(m_pBuffer, width, height, stride);</div><div class="line"></div><div class="line">    m_view_needs_redraw = <span class="keyword">true</span>;</div><div class="line">}</div></div><!-- fragment --><p>Probably you have noticed that the format of the bitmap (i.e., bytes per pixel, byte ordering, etc.) has not yet been specified. The place for doing it is at Lomse library initialization (see next section).</p>
<p>Deciding the how to allocate memory for the rendering buffer and the bitmap format to use are the most critical decisions when using Lomse. Depending on your application operating system and on the application framework used for coding it, the solution is different.</p>
<h1><a class="anchor" id="init-lomse"></a>
Initializing the Lomse library</h1>
<p>At Lomse library initialization it is neccesary to specify three mandatory values:</p>
<ol type="1">
<li>the bitmap format to use,</li>
<li>the resolution to use (pixels per inch), and</li>
<li>the y-axis orientation.</li>
</ol>
<p>Lets start with the y-axis orientation. Lomse needs to know if your presentation device follows the standard convention used in screen displays in which the y coordinates increases downwards, that is, y-axis coordinate 0 is at top of screen and increases downwards to bottom of screen. This convention is just the opposite of the normal convention for geometry, in which 0 coordinate is at bottom of paper and increases upwards. Lomse follows the standard convention used in displays (y-axis 0 coordinate at top and increases downwards). If your application is going to display the documents on screen then the standard convention is follwed and you don't have to reverse the y-axis. Otherwise, you will have to set this parameter as necessary.</p>
<p>The next decision is how your application will allocate memory for the rendering buffer and the bitmap format to use. Depending on your application operating system and on the application framework used for coding it, the solution is different. You should take these decissions by analyzing the most convenient and fast method for rendering the bitmaps. Sometimes the options are very limited.</p>
<p>Here are some tested configurations that work (see page <a class="el" href="page-examples.html">Tutorials and samples</a> for full application code samples):</p>
<table class="doxtable">
<tr>
<th>Application framework </th><th>Operating system </th><th>Memory for the bitmap </th><th>Bitmap format </th><th>Lomse bitmap format  </th></tr>
<tr>
<td>Qt </td><td>any </td><td>a QImage object </td><td>QImage::Format_RGBA8888 </td><td>k_pix_format_rgba32 </td></tr>
<tr>
<td>wxWidgets </td><td>any </td><td>a wxImage object </td><td>RGB 24 bits per pixel </td><td>k_pix_format_rgb24 </td></tr>
<tr>
<td>X11 </td><td>Linux </td><td>a XImage object </td><td>many suitable </td><td>many suitable </td></tr>
<tr>
<td>native Win32 API </td><td>MS Windows </td><td>a bitmap </td><td>BGRA, 32 bits per pixel </td><td>k_pix_format_bgra32 </td></tr>
</table>
<p>Please inform about any other configuration used by your application, for improving this documentation. Thank you.</p>
<p>For instance, for a Qt application you can use a QImage object as buffer, and use k_pix_format_rgba32:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> MyApp::initialize_lomse()</div><div class="line">{</div><div class="line">    <span class="comment">//the pixel format to use</span></div><div class="line">    <span class="keywordtype">int</span> pixel_format = <a class="code" href="group__enumerations.html#ggafb559e26bc610db43ba605230a142898ad6396874d1012fad53ebaff1393c8df8">k_pix_format_rgba32</a>;  <span class="comment">//QImage::Format_RGBA8888</span></div><div class="line"></div><div class="line">    <span class="comment">//the desired resolution, typically 96 pixels per inch for screen</span></div><div class="line">    <span class="keywordtype">int</span> resolution = 96;</div><div class="line"></div><div class="line">    <span class="comment">//Lomse default y axis direction is 0 coordinate at top and increases</span></div><div class="line">    <span class="comment">//downwards. You must specify if you would like just the opposite behaviour.</span></div><div class="line">    <span class="comment">//For MS Windows the Lomse default behaviour is the right behaviour.</span></div><div class="line">    <span class="keywordtype">bool</span> reverse_y_axis = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="comment">//initialize the Lomse library with these values</span></div><div class="line">    m_lomse.<a class="code" href="classLomseDoorway.html#a01e4f12682054e5a96afa236501ac80f">init_library</a>(pixel_format, resolution, reverse_y_axis);</div><div class="line">}</div></div><!-- fragment --><h1><a class="anchor" id="rendering-display"></a>
Displaying the document</h1>
<p>Once a document is open and the rendering buffer for the View is created, all your application has to do is to:</p><ol type="1">
<li>ask Lomse to render the desired portion of the document on the rendering buffer, and</li>
<li>copy the rendered bitmap onto the window.</li>
</ol>
<p>These operations are usually triggered in the handler for <b>window paint</b> events. Notice that there is no need to ask Lomse to paint the bitmap whenever a paint event arrives. These events are generated due to different reasons. The most frequent is when the window image is damaged (i.e. another window that was covering our window has moved). But in these cases the image is preserved in the bitmap so it is enough to re-display the bitmap. Other cases for receiving paint events are because the window has changed: when the window is created or when it is resized or when your application changes its content (i.e. because the user has open a different document). Flag <em>m_view_needs_redraw</em> is defined in your application for controlling the need to repaint the buffer: do it only when the repaint event is caused by a window resize or because the application has changed the content of the document; otherwise the Lomse buffer is still valid and you can save time by skipping to ask Lomse for a repaint:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> MyWindow::handle_paint_event(DeviceContext* paintDC)</div><div class="line">{</div><div class="line">    <span class="comment">//ensure that the bitmap has the right content or repaint it</span></div><div class="line">    update_rendering_buffer_if_needed();</div><div class="line"></div><div class="line">    <span class="comment">//copy the bitmap to the window.</span></div><div class="line">    <span class="comment">//AWARE: Platform dependent code. This is just an example </span></div><div class="line">    <span class="comment">//       using generic methods. Adapt this code before using</span></div><div class="line">    <span class="comment">//       it in a real application.</span></div><div class="line">    paintDC-&gt;BeginPaint();</div><div class="line">    paintDC-&gt;DrawBitmap(m_pBuffer, ...);</div><div class="line">    paintDC-&gt;EndPaint();</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> MyWindow::update_rendering_buffer_if_needed()</div><div class="line">{</div><div class="line">    <span class="comment">//request Lomse to re-draw the bitmap</span></div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (!m_pPresenter) <span class="keywordflow">return</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (m_view_needs_redraw)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (SpInteractor spInteractor = m_pPresenter-&gt;<a class="code" href="classPresenter.html#a3542802890a4615d251a5a786cee62b5">get_interactor</a>(0).lock())</div><div class="line">            spInteractor-&gt;force_redraw();</div><div class="line">        m_view_needs_redraw = <span class="keyword">false</span>;</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Overview</a></li>
    <li class="footer">Generated on Wed Nov 4 2020 09:41:24 for Lomse library. API documentation by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
